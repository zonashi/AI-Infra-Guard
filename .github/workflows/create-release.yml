name: ğŸš€ Create Release

on:
  push:
    tags:
      - v*

env:
  RELEASE_NAME: AI-Infra-Guard

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ›’ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“ Extract tag message
        id: tag-message
        run: |
          # è·å–æ ‡ç­¾ä¿¡æ¯
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          
          # è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾
          PREV_TAG=$(git tag --sort=-version:refname | grep -A1 "^$TAG_NAME$" | grep -v "^$TAG_NAME$" | head -1)
          
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæäº¤
          if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" = "$TAG_NAME" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          
          # è·å–ä¸¤ä¸ªç‰ˆæœ¬ä¹‹é—´çš„æäº¤æ¶ˆæ¯ï¼ˆå»é‡ï¼‰
          TAG_MESSAGE=$(git log ${PREV_TAG}..${TAG_NAME} --pretty=format:"%s" | sort | uniq | sed 's/^/- /')
          
          # å¦‚æœæ²¡æœ‰æäº¤æ¶ˆæ¯ï¼Œä½¿ç”¨é»˜è®¤æ¶ˆæ¯
          if [ -z "$TAG_MESSAGE" ]; then
            TAG_MESSAGE="Release $TAG_NAME"
          else
            TAG_MESSAGE="## æ›´æ–°å†…å®¹

$TAG_MESSAGE"
          fi
          
          # å°†æ¶ˆæ¯ä¿å­˜åˆ°æ–‡ä»¶ï¼Œå¤„ç†å¤šè¡Œå†…å®¹
          echo "$TAG_MESSAGE" > tag_message.txt
          echo "tag_message_file=tag_message.txt" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ Prepare release package
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p release-package
          # å¤åˆ¶å¿…è¦æ–‡ä»¶
          cp docker-compose.images.yml release-package/docker-compose.yml
          cp -r data release-package/data
          cp README.md release-package/README.md
          cp README_ZH.md release-package/README_ZH.md
          mkdir -p release-package/db
          mkdir -p release-package/log
          mkdir -p release-package/uploads
          
          # è·å–ç‰ˆæœ¬å·å¹¶ä¿®æ”¹ docker-compose.images.yml
          VERSION="${{ steps.tag-message.outputs.tag_name }}"
          
          # æ›¿æ¢ docker-compose.images.yml ä¸­çš„ latest æ ‡ç­¾ä¸ºå½“å‰ç‰ˆæœ¬å·
          sed -i "s/:latest/:${VERSION}/g" release-package/docker-compose.yml
          

      - name: ğŸ“¦ Create release archive
        run: |
          # åˆ›å»ºå‹ç¼©åŒ…
          cd release-package
          tar -czf ../AI-Infra-Guard-${{ steps.tag-message.outputs.tag_name }}.tar.gz .
          cd ..
          
          # åˆ›å»º ZIP åŒ…ï¼ˆWindows ç”¨æˆ·å‹å¥½ï¼‰
          cd release-package
          zip -r ../AI-Infra-Guard-${{ steps.tag-message.outputs.tag_name }}.zip .
          cd ..

      - name: ğŸ·ï¸ Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ env.RELEASE_NAME }} ${{ steps.tag-message.outputs.tag_name }}
          body_path: ${{ steps.tag-message.outputs.tag_message_file }}
          draft: false
          prerelease: false
          files: |
            AI-Infra-Guard-${{ steps.tag-message.outputs.tag_name }}.tar.gz
            AI-Infra-Guard-${{ steps.tag-message.outputs.tag_name }}.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Release Summary
        run: |
          echo "ğŸ‰ Release created successfully!"
          echo "ğŸ“¦ Release: ${{ env.RELEASE_NAME }} ${{ steps.tag-message.outputs.tag_name }}"
          echo "ğŸ“ Assets:"
          echo "   - AI-Infra-Guard-${{ steps.tag-message.outputs.tag_name }}.tar.gz"
          echo "   - AI-Infra-Guard-${{ steps.tag-message.outputs.tag_name }}.zip"
          echo "ğŸ”— Release URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.tag-message.outputs.tag_name }}"
