name: ðŸš€ Create Release

on:
  push:
    tags:
      - v*

env:
  RELEASE_NAME: AI-Infra-Guard

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ðŸ›’ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“ Extract tag message
        id: tag-message
        run: |
          # èŽ·å–æ ‡ç­¾ä¿¡æ¯
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          
          # èŽ·å–æ ‡ç­¾æ¶ˆæ¯
          TAG_MESSAGE=$(git tag -l --format='%(contents)' $TAG_NAME)
          
          # å¦‚æžœæ ‡ç­¾æ¶ˆæ¯ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤æ¶ˆæ¯
          if [ -z "$TAG_MESSAGE" ]; then
            TAG_MESSAGE="Release $TAG_NAME"
          fi
          
          # å°†æ¶ˆæ¯ä¿å­˜åˆ°æ–‡ä»¶ï¼Œå¤„ç†å¤šè¡Œå†…å®¹
          echo "$TAG_MESSAGE" > tag_message.txt
          echo "tag_message_file=tag_message.txt" >> $GITHUB_OUTPUT

      - name: ðŸ“¦ Prepare release package
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p release-package
          
          # å¤åˆ¶å¿…è¦çš„æ–‡ä»¶
          cp README.md release-package/
          cp docker-compose.yml release-package/
          cp docker-compose.images.yml release-package/
          
          # å¤åˆ¶ data ç›®å½•
          cp -r data release-package/
          
          # åˆ›å»ºå¯åŠ¨è„šæœ¬
          cat > release-package/start.sh << 'EOF'
          #!/bin/bash
          
          echo "ðŸš€ Starting AI-Infra-Guard..."
          echo "ðŸ“‹ System Requirements Check:"
          echo "   - Docker 20.10 or higher"
          echo "   - At least 4GB available memory"
          echo "   - At least 10GB available disk space"
          echo ""
          
          # æ£€æŸ¥ Docker æ˜¯å¦å®‰è£…
          if ! command -v docker &> /dev/null; then
              echo "âŒ Docker is not installed. Please install Docker first."
              echo "   Visit: https://docs.docker.com/get-started/get-docker/"
              exit 1
          fi
          
          # æ£€æŸ¥ Docker Compose æ˜¯å¦å¯ç”¨
          if ! docker compose version &> /dev/null && ! docker-compose --version &> /dev/null; then
              echo "âŒ Docker Compose is not available. Please install Docker Compose."
              exit 1
          fi
          
          echo "âœ… Docker environment check passed!"
          echo ""
          echo "ðŸ³ Starting AI-Infra-Guard services..."
          
          # ä½¿ç”¨é¢„æž„å»ºé•œåƒå¯åŠ¨æœåŠ¡
          if command -v docker-compose &> /dev/null; then
              docker-compose -f docker-compose.images.yml up -d
          else
              docker compose -f docker-compose.images.yml up -d
          fi
          
          echo ""
          echo "ðŸŽ‰ AI-Infra-Guard is starting up!"
          echo "ðŸ“± Web interface will be available at: http://localhost:8088"
          echo "â³ Please wait a moment for all services to be ready..."
          echo ""
          echo "ðŸ“š For more information, please read README.md"
          EOF
          
          chmod +x release-package/start.sh
          
          # åˆ›å»ºåœæ­¢è„šæœ¬
          cat > release-package/stop.sh << 'EOF'
          #!/bin/bash
          
          echo "ðŸ›‘ Stopping AI-Infra-Guard services..."
          
          if command -v docker-compose &> /dev/null; then
              docker-compose -f docker-compose.images.yml down
          else
              docker compose -f docker-compose.images.yml down
          fi
          
          echo "âœ… AI-Infra-Guard services stopped successfully!"
          EOF
          
          chmod +x release-package/stop.sh
          
          # åˆ›å»ºä½¿ç”¨è¯´æ˜Žæ–‡ä»¶
          cat > release-package/USAGE.md << 'EOF'
          # AI-Infra-Guard ä½¿ç”¨æŒ‡å—
          
          ## ðŸš€ å¿«é€Ÿå¼€å§‹
          
          ### ç³»ç»Ÿè¦æ±‚
          - Docker 20.10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - è‡³å°‘ 4GB å¯ç”¨å†…å­˜
          - è‡³å°‘ 10GB å¯ç”¨ç£ç›˜ç©ºé—´
          
          ### å¯åŠ¨æœåŠ¡
          
          **Linux/macOS:**
          ```bash
          ./start.sh
          ```
          
          **Windows:**
          ```cmd
          docker-compose -f docker-compose.images.yml up -d
          ```
          
          ### è®¿é—®æœåŠ¡
          æœåŠ¡å¯åŠ¨åŽï¼Œè®¿é—® Web ç•Œé¢ï¼š
          ```
          http://localhost:8088
          ```
          
          ### åœæ­¢æœåŠ¡
          
          **Linux/macOS:**
          ```bash
          ./stop.sh
          ```
          
          **Windows:**
          ```cmd
          docker-compose -f docker-compose.images.yml down
          ```
          
          ## ðŸ“ ç›®å½•è¯´æ˜Ž
          
          | ç›®å½•/æ–‡ä»¶                    | è¯´æ˜Ž                      |
          |----------------------------|---------------------------|
          | `data/`                    | çŸ¥è¯†åº“æ•°æ®ç›®å½•ï¼ˆæŒ‡çº¹åº“ã€æ¼æ´žåº“ï¼‰ |
          | `docker-compose.yml`       | ä»Žæºç æž„å»ºçš„ Docker é…ç½®    |
          | `docker-compose.images.yml`| ä½¿ç”¨é¢„æž„å»ºé•œåƒçš„ Docker é…ç½® |
          | `start.sh`                 | å¯åŠ¨è„šæœ¬ï¼ˆLinux/macOSï¼‰    |
          | `stop.sh`                  | åœæ­¢è„šæœ¬ï¼ˆLinux/macOSï¼‰    |
          | `README.md`                | è¯¦ç»†æ–‡æ¡£                   |
          | `USAGE.md`                 | æœ¬ä½¿ç”¨æŒ‡å—                 |
          
          ## ðŸ”§ æ•…éšœæŽ’é™¤
          
          1. **ç«¯å£å†²çª**ï¼šå¦‚æžœ 8088 ç«¯å£è¢«å ç”¨ï¼Œè¯·ä¿®æ”¹ docker-compose.images.yml ä¸­çš„ç«¯å£æ˜ å°„
          2. **æƒé™é—®é¢˜**ï¼šç¡®ä¿å¯åŠ¨è„šæœ¬æœ‰æ‰§è¡Œæƒé™ï¼š`chmod +x start.sh stop.sh`
          3. **Docker é—®é¢˜**ï¼šç¡®ä¿ Docker æœåŠ¡æ­£åœ¨è¿è¡Œ
          
          æ›´å¤šè¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒ README.md æ–‡ä»¶ã€‚
          EOF

      - name: ðŸ“¦ Create release archive
        run: |
          # åˆ›å»ºåŽ‹ç¼©åŒ…
          cd release-package
          tar -czf ../AI-Infra-Guard-${{ steps.tag-message.outputs.tag_name }}.tar.gz .
          cd ..
          
          # åˆ›å»º ZIP åŒ…ï¼ˆWindows ç”¨æˆ·å‹å¥½ï¼‰
          cd release-package
          zip -r ../AI-Infra-Guard-${{ steps.tag-message.outputs.tag_name }}.zip .
          cd ..

      - name: ðŸ·ï¸ Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ env.RELEASE_NAME }} ${{ steps.tag-message.outputs.tag_name }}
          body_path: ${{ steps.tag-message.outputs.tag_message_file }}
          draft: false
          prerelease: false
          files: |
            AI-Infra-Guard-${{ steps.tag-message.outputs.tag_name }}.tar.gz
            AI-Infra-Guard-${{ steps.tag-message.outputs.tag_name }}.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Release Summary
        run: |
          echo "ðŸŽ‰ Release created successfully!"
          echo "ðŸ“¦ Release: ${{ env.RELEASE_NAME }} ${{ steps.tag-message.outputs.tag_name }}"
          echo "ðŸ“ Assets:"
          echo "   - AI-Infra-Guard-${{ steps.tag-message.outputs.tag_name }}.tar.gz"
          echo "   - AI-Infra-Guard-${{ steps.tag-message.outputs.tag_name }}.zip"
          echo "ðŸ”— Release URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.tag-message.outputs.tag_name }}"
