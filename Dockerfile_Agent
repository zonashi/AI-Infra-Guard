# Stage 1: Build stage
FROM golang:1.23.2-alpine AS builder

# Install necessary system dependencies
RUN apk add --no-cache git ca-certificates

# Set working directory
WORKDIR /app

# 复制 go.mod 和 go.sum 文件
COPY go.mod go.sum /app/

# 下载依赖
RUN go mod download

# 复制源代码
COPY . /app/

# 构建应用程序
RUN GOOS=linux go build -a -o agent ./cmd/agent

# AIG-PromptSecurity
FROM python:3.12

WORKDIR /app/AIG-PromptSecurity

# 安装系统依赖（包括中文字体）
RUN apt-get update --allow-releaseinfo-change && \
    apt-get install -y --no-install-recommends \
    git \
    curl \
    nmap \
    chromium \
    fonts-wqy-microhei \
    fonts-wqy-zenhei \
    fontconfig \
    tzdata \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# 安装中文字体缓存
RUN fc-cache -fv
COPY ./AIG-PromptSecurity /app/AIG-PromptSecurity/
WORKDIR /app/AIG-PromptSecurity
RUN uv sync

ENV DEEPEVAL_TELEMETRY_OPT_OUT=YES
ENV DEEPTEAM_TELEMETRY_OPT_OUT=YES


# 安装MCP-SCAN
COPY ./mcp-scan /app/mcp-scan/
WORKDIR /app/mcp-scan
RUN pip install -r requirements.txt

# 从builder阶段复制agent
COPY --from=builder /app/agent /app/agent
COPY --from=builder /app/data /app/data

ENTRYPOINT ["/app/agent"]